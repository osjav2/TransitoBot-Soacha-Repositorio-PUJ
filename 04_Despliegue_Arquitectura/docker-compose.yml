services:
  # ============================================
  # BackRag - Sistema RAG con ChromaDB y Claude
  # ============================================
  backrag:
    build:
      context: ./backRag
      dockerfile: Dockerfile
    container_name: appchat-backrag
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      # Persistir ChromaDB entre reinicios
      - ./backRag/data:/app/data
    env_file:
      - ./backRag/.env.production
    depends_on:
      apistool:
        condition: service_healthy
    networks:
      - appchat-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ============================================
  # ApiTool - Servicio de envío de emails
  # ============================================
  apistool:
    build:
      context: ./apistool
      dockerfile: Dockerfile
    container_name: appchat-apistool
    restart: unless-stopped
    ports:
      - "8076:8076"
    env_file:
      - ./apistool/.env.production
    networks:
      - appchat-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8076/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # RASA - Bot Conversacional
  # ============================================
  rasa:
    build:
      context: ./rasa
      dockerfile: Dockerfile
    container_name: appchat-rasa
    restart: unless-stopped
    ports:
      - "5005:5005"  # RASA Server
      - "5055:5055"  # RASA Actions Server
    volumes:
      # IMPORTANTE: Modelos pre-entrenados deben estar en ./rasa/models/
      # Entrenar en máquina local y copiar el .tar.gz aquí
      # El contenedor NO entrena, solo consume el modelo del volumen
      - ./rasa/models:/app/models
    env_file:
      - ./rasa/.env.production
    networks:
      - appchat-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5005/').read()"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ============================================
  # RouterBack - Orquestador FastAPI
  # ============================================
  routerback:
    build:
      context: ./routerback
      dockerfile: Dockerfile
    container_name: appchat-routerback
    restart: unless-stopped
    ports:
      - "8080:8080"
    env_file:
      - ./routerback/.env.production
    depends_on:
      backrag:
        condition: service_healthy
      rasa:
        condition: service_healthy
    networks:
      - appchat-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ============================================
  # Frontend - React + Vite + Nginx
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: appchat-frontend
    restart: unless-stopped
    ports:
      - "5173:80"  # Mapear 5173 (dev) a 80 (nginx)
    env_file:
      - ./frontend/.env.production
    depends_on:
      - routerback
    networks:
      - appchat-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

# ============================================
# Networks
# ============================================
networks:
  appchat-network:
    driver: bridge
    name: appchat-network

# ============================================
# Named Volumes (declarados pero no usados actualmente)
# Se usan bind mounts en su lugar para facilitar desarrollo
# ============================================
volumes:
  backrag-data:
    name: appchat-backrag-data
  rasa-models:
    name: appchat-rasa-models
